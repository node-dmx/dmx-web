<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>DMX Lichtschalter</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link href="/js/bootstrap-combined.min.css" rel="stylesheet">
	<style>
	body {
		background: #222;
		color: #eee;
	}
	h1 {
		clear: both;
	}
	h1 span {
		font-size: small;
		color: lightgrey;
	}
	input[type=range] {
		-webkit-appearance: slider-vertical;
		height: 100px;
		width: 60px;
		margin-bottom: 2em;
		margin-top: 3em;
	}

	input[type=range]:before {
		content: attr(value);
		color: #eee;
		font-family: monospace;
		text-align: center;
		width: 60px;
		display: block;
		color: #fff;
		position: absolute;
		top: 2em;
	}
	.device {
		clear: both;
		padding-top: 1em;
	}
	.channel {
		position: relative;
		text-align: center;
		float: left;
	}
	.ranges {
		float: left;
		max-width: 200px;
	}
	.btn {
		margin-bottom: 1em;
	}
	</style>
	<script src="/js/jquery.min.js"></script>
	<script src="/js/jquery-ui.min.js"></script>
	<script src="/js/bootstrap.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		function get_html_id(universe, channel) {
			return 'channel_' + universe + '_' + channel;
		}

		function rgb_to_array(str) {
			matches = str.match(/^#([0-9a-f]{6})$/i)
			if (!matches) {
				return [0,0,0]
			}
			m = matches[1];
			if(m) {
				return [
					parseInt(m.substr(0,2),16),
					parseInt(m.substr(2,2),16),
					parseInt(m.substr(4,2),16)
				];
			}
		}

		function decimalToHex(d, padding) {
			var hex = Number(d).toString(16);
			padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;
			while (hex.length < padding) {
				hex = "0" + hex;
			}
			return hex;
		}

		function array_to_rgb(arr) {
			return '#'+decimalToHex(arr[0])+decimalToHex(arr[1])+decimalToHex(arr[2]);
		}

		var socket = io();
		socket.on('init', function (msg) {
			$('#presets').empty();
			$('#sliders').empty();
			$('#anim').empty();
			setup = msg.setup
			devices = msg.devices

			if(setup.title !== undefined) {
				document.title = setup.title;
			}
			
			/* preset buttons */
			for(var preset in setup.presets) {
				var html = '<button class="span2 btn btn-info">' + setup.presets[preset].label + '</button>';
				var e = $(html)
				e.hide().appendTo('#presets').fadeIn();
				e.click(function(values) { return function() {
					for(var universe in values) {
						socket.emit('update', universe, values[universe]);
					}
				};}(setup.presets[preset].values));
			}
			
			/* blackout button */
			var blackout = $('<button class="span2 btn btn-danger">Black Out</button>');
			blackout.hide().appendTo('#presets').fadeIn();
			blackout.click(function() {
				for(var universe in setup.universes) {
					var u = {};
					for(var i = 0; i < 255; i++) {
						u[i] = 0;
					}
					socket.emit('update', universe, u);
				}
			});
			
			/* sliders */
			for(var universe in setup.universes) {
				var html = "<div><h1>" + universe + " &nbsp; <span>(<a target=\"new\" href=\"/state/"+universe+"\">get state for preset</a>)</span></h1>";

				/* global device type control */
				var types = {}
				for(var device in setup.universes[universe].devices) {
					var dev = setup.universes[universe].devices[device];
					types[dev.type] = (types[dev.type] || []).concat([dev.address])
				}
				html += '<h4 class="name">Same Device Type Control</h4>';
				for (var type in types) {
					html += '<div class="device">';
					html += '<h5 class="name">'+type+'</h5>';

					for(var channel in devices[type].channels) {
						var channel_id = ''
						for (var type_channel in types[type]) channel_id += (Number(types[type][type_channel]) + Number(channel)) + ','
						var html_id = get_html_id(universe, channel_id);
						html += '<div class="channel">'
						html += '<label for="' + html_id + '">' + devices[type].channels[channel] + '</label>';
						html += '<input  id="' + html_id + '" type="range" min="0" value="0" max="255" orient="vertical">'
						html += '</div>'
					}

					html += '<div class="ranges">'
					// /* rgb */
					if(devices[type].channels.includes('red') && devices[type].channels.includes('blue') && devices[type].channels.includes('green')) {
						var html_id = get_html_id(universe, types[type].join(','));
						html += '<input id="picker_'+html_id+'" type="color" data-red="'+devices[type].channels.indexOf('red');
						html += '" data-green="'+devices[type].channels.indexOf('green')+'" data-blue="'+devices[type].channels.indexOf('blue')+'"/>';
					}

					/* ranges with options */
					if (devices[type].ranges) {
						for(var r in devices[type].ranges) {
							const range = devices[type].ranges[r]
							if (range.type !== 'option') continue
							
							var html_id = get_html_id(universe, types[type].join(','));
							html += '<select id="'+r+'_'+html_id+'">'
            				html += '<option values="">'+r+' values</option>'
							for(var k in range.options) {
								html += '<option value="' + range.options[k].value + '">'+ range.options[k].label +'</option>'
							}
							html += '</select>'
						}
					}
					html += '</div>'

					html += '</div>';
				}
				html += '</div>'

				/* individual device control */
				html += '<br style="clear: both;"/><br />'
				html += '<h4 class="name">Individual Device Control</h4>';
				for(var device in setup.universes[universe].devices) {
					var dev = setup.universes[universe].devices[device];
					html += '<div class="device">';
					if(dev.name !== undefined) {
						html += '<h5 class="name">'+dev.name+'</h5>'
					}
					for(var channel in devices[dev.type].channels) {
						var channel_id = dev.address + Number(channel)
						var html_id = get_html_id(universe, channel_id);
						html += '<div class="channel">'
						html += '<label for="' + html_id + '">' + devices[dev.type].channels[channel] + '</label>';
						html += '<input  id="' + html_id + '" type="range" min="0" value="0" max="255" orient="vertical">'
						html += '</div>'
					}

					html += '<div class="ranges">'

					/* rgb */
					if(devices[dev.type].channels.includes('red') && devices[dev.type].channels.includes('blue') && devices[dev.type].channels.includes('green')) {
						var html_id = get_html_id(universe, dev.address);
						html += '<input id="picker_'+html_id+'" type="color" data-red="'+devices[dev.type].channels.indexOf('red');
						html += '" data-green="'+devices[dev.type].channels.indexOf('green')+'" data-blue="'+devices[dev.type].channels.indexOf('blue')+'"/>';
					}

					/* ranges with options */
					if (devices[dev.type].ranges) {
						for(var r in devices[dev.type].ranges) {
							const range = devices[dev.type].ranges[r]
							if (range.type !== 'option') continue
							
							var html_id = get_html_id(universe, types[type].join(','));
							html += '<select id="'+r+'_'+html_id+'">'
            				html += '<option values="">'+r+' values</option>'
							for(var k in range.options) {
								html += '<option value="' + range.options[k].value + '">'+ range.options[k].label +'</option>'
							}
							html += '</select>'
						}
					}
					html += '</div>'
				}
				html += '</div>'
	
				html += "</div>";
				$(html).hide().appendTo('#sliders').fadeIn();
			}

			/* animations */
			for(var animation in setup.animPresets) {
				var html = '<button class="span2 btn btn-info">' + setup.animPresets[animation].label + '</button>';
				var e = $(html)
				e.hide().appendTo('#anim').fadeIn();
				e.click(function(values) { return function() {
					for(var universe in values) {
						$.ajax({
							type: 'POST',
							contentType: 'application/json',
							data: JSON.stringify(values[universe]),
							url: '/animation/'+universe,
							processData: false,
							dataType: 'json'
						});
					}
				};}(setup.animPresets[animation].anim));
			}

			$("input").live("change", function(e) {
				var i = e.target.id.split('_');
				if(i[0] === 'picker') {
					var u = {};
					var tar = $(e.target);
					var value = rgb_to_array(tar.val());
					
					i[3] = i[3].split(',')
					for (var port in i[3]) {
						u[Number(port)+Number(tar.data('red'))] = value[0];
						u[Number(port)+Number(tar.data('green'))] = value[1];
						u[Number(port)+Number(tar.data('blue'))] = value[2];
					}
					
					console.log(i[2], u)
					socket.emit('update', i[2], u);
				} else {
					var u = {};
					console.log(i)

					i[2] = i[2].split(',')
					for (var port in i[2]) {
						u[i[2][Number(port)]] = Number(e.target.value)
					}
					
					console.log(i[1], u)
					socket.emit('update', i[1], u);
				}
			});
			$("select").live("change", function(e) {
				var i = e.target.id.split('_');
				var u = {};

				i[3] = i[3].split(',')
				for (var port in i[3]) {
					if (i[0] === 'ctrl') {
						u[i[3][Number(port)]] = Number(e.target.value)
					} else {
						console.log(i[3][port])
						u[i[3][port]] = 11;
						u[i[3][port]+1] = Number(e.target.value); // todo find number of option	
					} 
				}

				console.log("update", i[2], u)
				socket.emit('update', i[2], u);
			})
			
			socket.emit('request_refresh');
		});
		socket.on('update', function (universe, update) {
			for(var k in update) {
				$('#' + get_html_id(universe, k)).attr('value', update[k]);
			}
			$("[id^=picker_channel_"+universe+"]").each(function(index, value){
				var self = $(this);
				var id = self.attr('id').split('_');
				var obj = self.data();
				var arr = Object.keys(obj).map(function(key){return obj[key];});
				var _id = Number(id[3]);
				var min = _id;
				var max = min;
				min += Math.min.apply( null, arr );
				max += Math.max.apply( null, arr );
				for(var k in update) {
					if(k >= min && k <= max) {
						var values = rgb_to_array(self.val());
						var address = k - _id;
						if(address === Number(self.data('red'))) {
							values[0] = update[k];
						}
						else if(address === Number(self.data('green'))) {
							values[1] = update[k];
						}
						else if(address === Number(self.data('blue'))) {
							values[2] = update[k];
						}
						self.val(array_to_rgb(values));
					}
				}
			});
			
		});
		console.log(socket)
	</script>
</head>
<body>
	<div class="navbar navbar-inverse">
	<div class="navbar-inner">
	<ul class="nav" id="myTab">
	  <li class="active"><a href="#home" data-toggle="tab">Home</a></li>
	  <li><a href="#sliders" data-toggle="tab">Sliders</a></li>
	  <li><a href="#anim" data-toggle="tab">Animations</a></li>
	  <!--<li><a href="#scripts" data-toggle="tab">Scripts</a></li>-->
	</ul>
	</div>
	</div>

<div class="container-fluid">
<div class="tab-content">
<div id="home"    class="tab-pane active">
	<div class="row-fluid" id="presets">
	</div>
</div>
<div id="sliders" class="tab-pane">

</div>
<div id="anim"    class="tab-pane">

</div>
<div id="scripts"    class="tab-pane">
	
</div>

</div>
</div>
</body>
</html>
